#!/usr/bin/env bash
# Fixed Soundness installation script

set -euo pipefail

echo "==> Updating system and installing dependencies ..."
apt update && apt upgrade -y
apt install -y build-essential protobuf-compiler curl wget pkg-config \
    libcrypto++-dev libc6-dev openssl libssl-dev

echo "==> Installing soundnessup ..."
curl -sSL https://raw.githubusercontent.com/soundnesslabs/soundness-layer/main/soundnessup/install | bash

echo "==> Installing Rust ..."
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs/ | sh -s -- -y

# Source Rust environment
if [ -f "$HOME/.cargo/env" ]; then
    source "$HOME/.cargo/env"
fi

# Attempt to source .bashrc ONLY if PS1 is already defined
if [ -n "${PS1:-}" ]; then
    source "$HOME/.bashrc" || true
fi

# Manually export path additions
export PATH="$HOME/.soundnessup/bin:$HOME/.cargo/bin:$PATH"

# Run soundnessup once to ensure setup completes
echo "==> Running soundnessup once to initialize environment ..."
"$HOME/.soundnessup/bin/soundnessup" || true

# Check again if command is now available
if ! command -v soundnessup &>/dev/null; then
    echo "❌ soundnessup still not available — something went wrong with setup"
    exit 1
fi

echo "==> Installing and updating Soundness CLI ..."
soundnessup install
soundnessup update

echo
echo "==> Generating key named 'my-key' (enter passphrase when prompted) ..."
soundness-cli generate-key --name my-key
echo

read -r -p "Export the public key now? [y/N]: " export_reply
if [[ "$export_reply" =~ ^[Yy]([Ee][Ss])?$ ]]; then
    soundness-cli export-key --name my-key
    echo "✅ Public key exported."
else
    echo "ℹ️ Skipped export. You can run: soundness-cli export-key --name my-key"
fi

echo
echo "✅ Soundness setup complete!"
echo "Make sure to add this to your shell config for future use:"
echo 'export PATH="$HOME/.soundnessup/bin:$HOME/.cargo/bin:$PATH"'